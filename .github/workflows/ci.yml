name: CI

on:
  push:
    branches: [main]
    paths:
      - "bin/**"
      - "lib/**"
      - "test/**"
      - "config/**"
      - ".github/workflows/ci.yml"
      - "release-please-config.json"
      - ".release-please-manifest.json"
  pull_request:
    branches: [main]
    paths:
      - "bin/**"
      - "lib/**"
      - "test/**"
      - "config/**"
      - ".github/workflows/ci.yml"

permissions:
  contents: write
  pull-requests: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Zsh
        run: sudo apt-get update && sudo apt-get install -y zsh

      - name: Check Syntax
        run: |
          find lib -name "*.zsh" -print0 | xargs -0 -I {} zsh -n {}
          zsh -n bin/macsync
          echo "âœ… Syntax check passed"

  test:
    name: Test
    needs: lint
    runs-on: macos-latest
    timeout-minutes: 10
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v6

      - name: ðŸ“¦ Cache Homebrew
        uses: actions/cache@v5
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar/bats-core
          key: ${{ runner.os }}-brew-bats-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: |
            ${{ runner.os }}-brew-bats-

      - name: ðŸº Install BATS
        run: |
          brew install bats-core || true
          brew link --overwrite bats-core

      - name: ðŸ§ª Run tests
        run: bats test/macsync.bats

      - name: âœ… Summary
        if: success()
        run: echo "All tests passed!"

  release:
    name: Release
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v6

      - name: ðŸ•º Release
        uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  update-brew-tap:
    name: Update Homebrew Tap
    needs: release
    if: ${{ needs.release.outputs.releases_created == 'true' && needs.release.outputs.tag_name != '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v6

      - name: ðŸº Update Homebrew Tap
        env:
          TAG: ${{ needs.release.outputs.tag_name }}
          TAP_REPO: Pilaton/homebrew-tap
          TAP_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [[ -z "${TAP_TOKEN:-}" ]]; then
            echo "::error::TAP_GITHUB_TOKEN secret is not set"
            exit 1
          fi

          URL="https://github.com/${GITHUB_REPOSITORY}/archive/refs/tags/${TAG}.tar.gz"
          echo "Downloading ${URL}..."

          if ! curl -fsSL -o release.tar.gz "${URL}"; then
            echo "::error::Failed to download release archive"
            exit 1
          fi

          SHA256=$(sha256sum release.tar.gz | awk '{print $1}')
          echo "SHA256: ${SHA256}"

          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git config --global credential.helper store
          echo "https://x-access-token:${TAP_TOKEN}@github.com" > ~/.git-credentials

          if ! git clone "https://github.com/${TAP_REPO}.git" tap-repo; then
            echo "::error::Failed to clone tap repository"
            exit 1
          fi
          cd tap-repo

          FORMULA_PATH="Formula/macsync.rb"

          if [[ ! -f "${FORMULA_PATH}" ]]; then
            echo "::error::Formula not found at ${FORMULA_PATH}"
            exit 1
          fi

          echo "Updating formula..."

          if ! grep -q 'url "' "${FORMULA_PATH}"; then
            echo "::error::Could not find url field in formula"
            exit 1
          fi
          sed -i "s|url \".*\"|url \"${URL}\"|" "${FORMULA_PATH}"

          if ! grep -q 'sha256 "' "${FORMULA_PATH}"; then
            echo "::error::Could not find sha256 field in formula"
            exit 1
          fi
          sed -i "s|sha256 \".*\"|sha256 \"${SHA256}\"|" "${FORMULA_PATH}"

          git add "${FORMULA_PATH}"
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update macsync formula to ${TAG}"
            git push origin main
            echo "âœ… Formula updated successfully"
          fi

      - name: ðŸ§¹ Cleanup credentials
        if: always()
        run: rm -f ~/.git-credentials
