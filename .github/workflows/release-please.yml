on:
  push:
    branches:
      - main
name: ðŸš€ release-please

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: ðŸ•º release
        uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: simple
          package-name: MacSync
          extra-files: VERSION

  update-brew-tap:
    needs: release-please
    if: ${{ needs.release-please.outputs.releases_created }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸº Update Homebrew Tap
        env:
          TAG: ${{ needs.release-please.outputs.tag_name }}
          TAP_REPO: Pilaton/homebrew-tap
          TAP_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Validate required secrets
          if [[ -z "${TAP_TOKEN:-}" ]]; then
            echo "::error::TAP_GITHUB_TOKEN secret is not set"
            exit 1
          fi

          # 1. Download release archive and compute SHA256
          URL="https://github.com/${GITHUB_REPOSITORY}/archive/refs/tags/${TAG}.tar.gz"
          echo "Downloading ${URL}..."

          if ! curl -fsSL -o release.tar.gz "${URL}"; then
            echo "::error::Failed to download release archive"
            exit 1
          fi

          SHA256=$(sha256sum release.tar.gz | awk '{print $1}')
          echo "SHA256: ${SHA256}"

          # 2. Configure git credentials securely
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git config --global credential.helper store
          echo "https://x-access-token:${TAP_TOKEN}@github.com" > ~/.git-credentials

          # 3. Clone the tap repository
          if ! git clone "https://github.com/${TAP_REPO}.git" tap-repo; then
            echo "::error::Failed to clone tap repository"
            exit 1
          fi
          cd tap-repo

          # 4. Update the formula
          FORMULA_PATH="Formula/macsync.rb"

          if [[ ! -f "${FORMULA_PATH}" ]]; then
            echo "::error::Formula not found at ${FORMULA_PATH}"
            exit 1
          fi

          echo "Updating formula..."

          # Update URL and verify change was made
          if ! grep -q 'url "' "${FORMULA_PATH}"; then
            echo "::error::Could not find url field in formula"
            exit 1
          fi
          sed -i "s|url \".*\"|url \"${URL}\"|" "${FORMULA_PATH}"

          # Update SHA256 and verify change was made
          if ! grep -q 'sha256 "' "${FORMULA_PATH}"; then
            echo "::error::Could not find sha256 field in formula"
            exit 1
          fi
          sed -i "s|sha256 \".*\"|sha256 \"${SHA256}\"|" "${FORMULA_PATH}"

          # 5. Commit and push
          git add "${FORMULA_PATH}"
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update macsync formula to ${TAG}"
            git push origin main
            echo "âœ… Formula updated successfully"
          fi

      - name: ðŸ§¹ Cleanup credentials
        if: always()
        run: rm -f ~/.git-credentials
